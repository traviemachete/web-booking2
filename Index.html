<!-- Index.html -->

<!DOCTYPE html>
<html lang="th">

<head>
  <base target="_top">
  <meta charset="UTF-8">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Google Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Custom Stylesheet -->
  <?!= include('Stylesheet') ?>

  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">

  <!-- SweetAlert2 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
</head>

<body>
  <!-- Sidebar Navigation -->
  <nav class="sidebar">
    <h5>üè¢ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</h5>

    <!-- User Info Section -->
    <div class="user-info" id="userInfo">
      <div class="user-loading">
        <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
      </div>
    </div>

    <!-- Navigation Menu -->
    <ul class="nav-menu">
      <li>
        <a href="#" onclick="loadView('calendar'); return false;" id="nav-calendar" class="active">
          üìÖ ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
        </a>
      </li>
      <li>
        <a href="#" onclick="checkAuthAndNavigate('form'); return false;" id="nav-form">
          üìù ‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°
        </a>
      </li>
    </ul>
  </nav>

  <!-- Main Content Area -->
  <main class="main">
    <div id="mainContent">
      <!-- Dynamic content will be loaded here -->
      <div class="loading-placeholder">
        <div class="loading-content">
          <div class="loading-spinner"></div>
          <h3>üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</h3>
          <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</p>
        </div>
      </div>
    </div>
  </main>

  <!-- External Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Custom JavaScript -->
  <?!= include('JavaScript') ?>

  <script>
    // Global variables
    let currUser = null;
    let authChecked = false;

    // Initialize app when page loads
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üöÄ Initializing booking system...');
      
      // Initialize theme first
      initializeTheme();
      
      // ‚úÖ Restore session if exists
      const savedSession = sessionStorage.getItem('booking_session');
      if (savedSession) {
        const session = JSON.parse(savedSession);
        if (session.expires > Date.now()) {
          window.currentUser = session.user;
          window.authChecked = true;
          renderUserBox(session.user);
          console.log('üîê Session restored from sessionStorage');
        } else {
          sessionStorage.removeItem('booking_session');
          console.log('üóëÔ∏è Session expired and cleared');
        }
      }

      // Check authentication and render user box
      checkAuthAndRenderUserBox();
      
      // Load default view after auth check
      setTimeout(() => {
        loadView('calendar');
      }, 800);
    });

    // Theme management
    function initializeTheme() {
      const savedTheme = localStorage.getItem("booking-theme") || "light";
      document.documentElement.setAttribute("data-theme", savedTheme);
      console.log('üé® Theme initialized:', savedTheme);
    }

    function toggleTheme() {
      const headerToggle = document.getElementById("themeToggleHeader");
      
      let newTheme;
      if (headerToggle && headerToggle.checked !== undefined) {
        newTheme = headerToggle.checked ? "dark" : "light";
      } else {
        const currentTheme = document.documentElement.getAttribute("data-theme") || "light";
        newTheme = currentTheme === "dark" ? "light" : "dark";
      }
      
      document.documentElement.setAttribute("data-theme", newTheme);
      localStorage.setItem("booking-theme", newTheme);
      
      // Sync toggle
      if (headerToggle) headerToggle.checked = newTheme === "dark";
      
      console.log('üé® Theme changed to:', newTheme);
    }

    // Authentication check and user box rendering
    function checkAuthAndRenderUserBox() {
      if (typeof google !== 'undefined' && google.script && google.script.run) {
        google.script.run
          .withSuccessHandler(function(user) {
            currentUser = user;
            authChecked = true;
            renderUserBox(user);
            console.log('üë§ User status:', user ? `Logged in as ${user.name}` : 'Not logged in');
          })
          .withFailureHandler(function(error) {
            console.error('‚ùå Auth check failed:', error);
            currentUser = null;
            authChecked = true;
            renderUserBox(null);
          })
          .getSessionUser();
      } else {
        // Fallback for testing
        currentUser = null;
        authChecked = true;
        renderUserBox(null);
        console.log('‚ö†Ô∏è Google Apps Script not available');
      }
    }

    // Render user info box
    function renderUserBox(user) {
      const userInfoEl = document.getElementById("userInfo");
      if (!userInfoEl) return;

      if (user) {
        userInfoEl.innerHTML = `
          <div class="user-profile">
            <div class="user-avatar">
              <span class="avatar-icon">üë§</span>
            </div>
            <div class="user-details">
              <p class="user-name">${user.name}</p>
              <p class="user-email">${user.email}</p>
            </div>
          </div>
          <button class="logout-btn" onclick="logout()">
            <span>üö™</span> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
          </button>
        `;
      } else {
        userInfoEl.innerHTML = `
          <div class="auth-prompt">
            <p class="auth-text">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</p>
            <button class="login-btn" onclick="loadView('login')">
              <span>üîë</span> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
            </button>
          </div>
        `;
      }
    }

    // Logout function
    function logout() {
      if (typeof google !== 'undefined' && google.script && google.script.run) {
        google.script.run
          .withSuccessHandler(function() {
            currentUser = null;
            renderUserBox(null);
            
            if (typeof Swal !== 'undefined') {
              Swal.fire({
                icon: 'success',
                title: '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß',
                text: '‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£',
                timer: 1500,
                showConfirmButton: false
              });
            }
            
            // Redirect to calendar
            setTimeout(() => {
              loadView('calendar');
            }, 1000);
          })
          .withFailureHandler(function(error) {
            console.error('Logout failed:', error);
            if (typeof Swal !== 'undefined') {
              Swal.fire({
                icon: 'error',
                title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ'
              });
            }
          })
          .logoutUser();
      } else {
        // Fallback for testing
        currentUser = null;
        renderUserBox(null);
        loadView('calendar');
      }
    }

    // Check auth before navigation
    function checkAuthAndNavigate(viewName) {
      if (!authChecked) {
        // Wait for auth check
        setTimeout(() => checkAuthAndNavigate(viewName), 200);
        return;
      }

      if (currentUser) {
        // User is logged in, proceed to view
        loadView(viewName);
      } else {
        // User not logged in, show login prompt
        if (typeof Swal !== 'undefined') {
          Swal.fire({
            icon: 'info',
            title: '‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö',
            text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°',
            showCancelButton: true,
            confirmButtonText: '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö',
            cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
            confirmButtonColor: '#1a73e8',
            cancelButtonColor: '#6c757d'
          }).then((result) => {
            if (result.isConfirmed) {
              loadView('login');
            }
          });
        } else {
          // Fallback without SweetAlert
          if (confirm('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°')) {
            loadView('login');
          }
        }
      }
    }

    // Navigation helpers
    function setActiveNav(viewName) {
      // Remove active class from all nav items
      document.querySelectorAll('.nav-menu a').forEach(link => {
        link.classList.remove('active');
      });
      
      // Add active class to current nav item
      const activeNav = document.getElementById(`nav-${viewName}`);
      if (activeNav) {
        activeNav.classList.add('active');
      }
      
      console.log('üìç Navigation set to:', viewName);
    }

    // Load view function
    function loadView(viewName, forceRefresh = false) {
      console.log('üìÑ Loading view:', viewName);
      
      const mainContent = document.getElementById('mainContent');
      if (!mainContent) {
        console.error('‚ùå Main content element not found');
        return;
      }

      // Update navigation
      setActiveNav(viewName);
      
      // Show loading state
      if (!forceRefresh) {
        mainContent.innerHTML = `
          <div class="loading-placeholder">
            <div class="loading-content">
              <div class="loading-spinner"></div>
              <h3>üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</h3>
              <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</p>
            </div>
          </div>
        `;
      }

      // View mapping
      const viewMap = {
        calendar: 'CalendarView',
        form: 'Form',
        list: 'TodayList',
        login: 'Login',
        register: 'Register',
        forgot: 'ForgotPassword',
      };

      const templateName = viewMap[viewName] || 'CalendarView';
      
      // Load from Google Apps Script
      if (typeof google !== 'undefined' && google.script && google.script.run && google.script.run.include) {
        google.script.run
          .withSuccessHandler(function(html) {
            mainContent.innerHTML = html;
            handleViewLoaded(viewName);
            console.log('‚úÖ View loaded successfully:', viewName);
          })
          .withFailureHandler(function(error) {
            console.error('‚ùå Failed to load view from server:', error);
            mainContent.innerHTML = `
              <div class="error-container">
                <div class="error-content">
                  <h3>‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h3>
                  <p>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
                  <button onclick="loadView('${viewName}')" class="retry-btn">
                    üîÑ ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
                  </button>
                </div>
              </div>
            `;
          })
          .include(templateName);
      } else {
        // Fallback when Google Apps Script is not available
        console.error('‚ùå Google Apps Script not available');
        mainContent.innerHTML = getFallbackContent(viewName);
        handleViewLoaded(viewName);
      }
    }

    // Handle post-load actions
    function handleViewLoaded(viewName) {
      if (viewName === 'calendar') {
        setTimeout(() => {
          // Load events from Google Apps Script
          if (typeof google !== 'undefined' && google.script && google.script.run) {
            google.script.run
              .withSuccessHandler(function(events) {
                if (typeof renderCalendar === 'function') {
                  renderCalendar(events);
                } else {
                  console.error('‚ùå renderCalendar function not found');
                }
              })
              .withFailureHandler(function(error) {
                console.error('‚ùå Failed to load events:', error);
                const calendarEl = document.getElementById('calendar');
                if (calendarEl) {
                  calendarEl.innerHTML = `
                    <div class="calendar-error">
                      <h3>‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</h3>
                      <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Apps Script</p>
                      <button onclick="loadView('calendar', true)" class="retry-btn">
                        üîÑ ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
                      </button>
                    </div>
                  `;
                }
              })
              .listEvents();
          } else {
            console.error('‚ùå Google Apps Script not available for loading events');
            // Use fallback sample data
            if (typeof renderCalendar === 'function') {
              renderCalendar(getSampleEvents());
            }
          }
        }, 200);

        if (viewName === 'forgot') {
          if (typeof initForgotPassword === 'function') {
            initForgotPassword();
            console.log('‚úÖ initForgotPassword() called');
          } else {
            console.warn('‚ö†Ô∏è initForgotPassword() not found');
          }
        }

      }
      
      // Handle form view
      if (viewName === 'form') {
        setTimeout(() => {
          setupFormDefaults();
        }, 100);
      }
    
      // Sync theme toggle in header if exists
      const headerToggle = document.getElementById('themeToggleHeader');
      if (headerToggle) {
        const savedTheme = localStorage.getItem("booking-theme") || "light";
        headerToggle.checked = savedTheme === "dark";
      }
    }

    // Setup form defaults
    function setupFormDefaults() {
      // Set default date to today or selected date
      const today = new Date().toISOString().split('T')[0];
      const selectedDate = localStorage.getItem('selectedDate') || today;
      
      const dateInput = document.getElementById('date');
      if (dateInput) {
        dateInput.value = selectedDate;
        dateInput.setAttribute('min', today); // Prevent past dates
      }
      
      // Clear selected date from localStorage
      localStorage.removeItem('selectedDate');

      // Set default time range (9:00 AM - 10:00 AM)
      const startInput = document.getElementById('start');
      const endInput = document.getElementById('end');
      if (startInput && !startInput.value) {
        startInput.value = '09:00';
      }
      if (endInput && !endInput.value) {
        endInput.value = '10:00';
      }
    }

    // Get sample events for fallback
    function getSampleEvents() {
      const today = new Date();
      return [
        {
          id: 'sample-1',
          title: '‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏ó‡∏µ‡∏° IT',
          start: new Date(today.getFullYear(), today.getMonth(), today.getDate() + 1, 9, 0),
          end: new Date(today.getFullYear(), today.getMonth(), today.getDate() + 1, 11, 0),
          backgroundColor: '#1a73e8',
          extendedProps: {
            booker: '‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ',
            department: '‡∏ù‡πà‡∏≤‡∏¢‡πÑ‡∏≠‡∏ó‡∏µ',
            company: '‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ABC',
            purpose: '‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå',
            email: 'somchai@abc.com'
          }
        },
        {
          id: 'sample-2',
          title: '‡∏≠‡∏ö‡∏£‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà',
          start: new Date(today.getFullYear(), today.getMonth(), today.getDate() + 2, 13, 0),
          end: new Date(today.getFullYear(), today.getMonth(), today.getDate() + 2, 16, 0),
          backgroundColor: '#34a853',
          extendedProps: {
            booker: '‡∏™‡∏∏‡∏î‡∏≤ ‡∏ô‡∏±‡∏Å‡∏≠‡∏ö‡∏£‡∏°',
            department: '‡∏ù‡πà‡∏≤‡∏¢ HR',
            company: '‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ABC',
            purpose: '‡∏≠‡∏ö‡∏£‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà',
            email: 'suda@abc.com'
          }
        }
      ];
    }

    // Get fallback content for testing
    function getFallbackContent(viewName) {
      const fallbackContents = {
        calendar: `
          <div class="calendar-container">
            <div class="calendar-header">
              <h4>üìÖ ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</h4>
              <div class="calendar-actions">
                <button class="refresh-btn" onclick="refreshCalendarData()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
                <button class="add-btn" onclick="checkAuthAndNavigate('form')">‚ûï ‡∏à‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</button>
              </div>
            </div>
            <div id="calendar"></div>
            <div class="calendar-footer">
              <div class="calendar-legend">
                <div class="legend-item">
                  <span class="legend-color" style="background: #1a73e8;"></span>
                  <span>‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏õ‡∏Å‡∏ï‡∏¥</span>
                </div>
                <div class="legend-item">
                  <span class="legend-color" style="background: #ea4335;"></span>
                  <span>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß</span>
                </div>
                <div class="legend-item">
                  <span class="legend-color" style="background: #34a853;"></span>
                  <span>‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>
                </div>
              </div>
            </div>
          </div>
        `,
        form: `
          <div class="form-container">
            <div class="form-header">
              <h3 class="form-title">üìù ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</h3>
              <p class="form-subtitle">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google Apps Script ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°</p>
            </div>
            <div class="form-actions">
              <button class="btn btn-secondary" onclick="loadView('calendar')">
                ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
              </button>
            </div>
          </div>
        `,
        list: `
          <div class="text-center" style="padding: 40px; color: var(--text-secondary);">
            <h3>üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
            <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google Apps Script ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</p>
          </div>
        `,
        login: `
          <div class="auth-container">
            <div class="auth-card">
              <div class="auth-header">
                <div class="auth-logo">
                  <span class="logo-icon">üè¢</span>
                  <h2 class="logo-text">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</h2>
                </div>
                <h3 class="auth-title">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h3>
                <p class="auth-subtitle">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google Apps Script ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
              </div>
            </div>
          </div>
        `,
        register: `
          <div class="auth-container">
            <div class="auth-card">
              <div class="auth-header">
                <div class="auth-logo">
                  <span class="logo-icon">üè¢</span>
                  <h2 class="logo-text">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</h2>
                </div>
                <h3 class="auth-title">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h3>
                <p class="auth-subtitle">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google Apps Script ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
              </div>
            </div>
          </div>
        `
      };
      
      return fallbackContents[viewName] || fallbackContents.calendar;
    }

    // Refresh calendar - load from server
    function refreshCalendar() {
      console.log('üîÑ Refreshing calendar from server...');
      
      if (typeof google !== 'undefined' && google.script && google.script.run) {
        const refreshBtn = document.querySelector('.refresh-btn');
        if (refreshBtn) {
          const originalText = refreshBtn.innerHTML;
          refreshBtn.innerHTML = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';
          refreshBtn.disabled = true;
          
          google.script.run
            .withSuccessHandler(function(events) {
              if (typeof renderCalendar === 'function') {
                renderCalendar(events);
              }
              
              // Reset button
              refreshBtn.innerHTML = originalText;
              refreshBtn.disabled = false;
              
              if (typeof Swal !== 'undefined') {
                Swal.fire({
                  icon: 'success',
                  title: '‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                  text: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß',
                  timer: 1500,
                  showConfirmButton: false
                });
              }
              
              console.log('‚úÖ Calendar refreshed successfully');
            })
            .withFailureHandler(function(error) {
              console.error('‚ùå Failed to refresh calendar:', error);
              
              // Reset button
              refreshBtn.innerHTML = originalText;
              refreshBtn.disabled = false;
              
              if (typeof Swal !== 'undefined') {
                Swal.fire({
                  icon: 'error',
                  title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                  text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á'
                });
              }
            })
            .listEvents();
        }
      } else {
        console.error('‚ùå Google Apps Script not available');
        if (typeof Swal !== 'undefined') {
          Swal.fire({
            icon: 'info',
            title: '‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö',
            text: '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google Apps Script ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'
          });
        }
      }
    }

    // Alias for refresh function
    function refreshCalendarData() {
      refreshCalendar();
    }

    // Global error handler
    window.addEventListener('error', function(e) {
      console.error('üí• Global error:', e.error);
    });

    // Export functions for global access
    window.loadView = loadView;
    window.toggleTheme = toggleTheme;
    window.checkAuthAndNavigate = checkAuthAndNavigate;
    window.renderUserBox = renderUserBox;
    window.refreshCalendar = refreshCalendar;
    window.refreshCalendarData = refreshCalendarData;
    window.logout = logout;
    window.currentUser = currentUser;
    window.authChecked = authChecked;

    console.log('üìù Booking system script loaded');

  </script>
  <script>
  document.addEventListener('DOMContentLoaded', function () {
    if (typeof restoreSession === 'function') restoreSession();
  });
  </script>

  

</body>

</html>

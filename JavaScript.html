<!-- JavaScript.html -->
<script>
  // ===== EMERGENCY FIX - ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏ô‡πÑ‡∏ü‡∏•‡πå JavaScript.html =====

// Global error handler ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≤‡∏ß
window.addEventListener('error', function(e) {
  console.error('üí• JavaScript Error:', e.error);
  console.error('üìç Location:', e.filename + ':' + e.lineno);
  
  // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≤‡∏ß‡πÇ‡∏î‡∏¢‡πÅ‡∏™‡∏î‡∏á error message
  const mainContent = document.getElementById('mainContent');
  if (mainContent && !mainContent.innerHTML.trim()) {
    mainContent.innerHTML = `
      <div style="padding: 40px; text-align: center; color: #dc3545;">
        <h3>‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h3>
        <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</p>
        <button onclick="location.reload()" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">
          üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤
        </button>
        <details style="margin-top: 20px; text-align: left;">
          <summary>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•)</summary>
          <pre style="background: #f8f9fa; padding: 10px; border-radius: 5px; font-size: 12px;">${e.error?.stack || e.error?.message || 'Unknown error'}</pre>
        </details>
      </div>
    `;
  }
  
  return false; // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô default error handling
});

// Safe DOM ready function
function safeReady(callback) {
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', callback);
  } else {
    callback();
  }
}

// Safe element selection
function safeGetElement(id) {
  try {
    const element = document.getElementById(id);
    if (!element) {
      console.warn(`‚ö†Ô∏è Element not found: ${id}`);
    }
    return element;
  } catch (e) {
    console.error(`‚ùå Error getting element ${id}:`, e);
    return null;
  }
}

// Safe event listener addition
function safeAddEventListener(element, event, handler) {
  try {
    if (element && typeof element.addEventListener === 'function') {
      element.addEventListener(event, handler);
      return true;
    } else {
      console.warn(`‚ö†Ô∏è Cannot add event listener to:`, element);
      return false;
    }
  } catch (e) {
    console.error(`‚ùå Error adding event listener:`, e);
    return false;
  }
}

// Safe function execution
function safeExecute(fn, context = 'Unknown') {
  try {
    if (typeof fn === 'function') {
      return fn();
    } else {
      console.warn(`‚ö†Ô∏è ${context}: Not a function`);
      return null;
    }
  } catch (e) {
    console.error(`‚ùå ${context} error:`, e);
    return null;
  }
}

// ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà DOMContentLoaded event ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏î‡πâ‡∏ß‡∏¢‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ
safeReady(function() {
  console.log('üöÄ Safe DOM Ready - Initializing...');
  
  // Initialize theme first
  safeExecute(() => {
    const savedTheme = localStorage.getItem("booking-theme") || "light";
    document.documentElement.setAttribute("data-theme", savedTheme);
    console.log('üé® Theme initialized:', savedTheme);
  }, 'Theme initialization');
  
  // Check auth with safety
  safeExecute(() => {
    if (typeof checkAuthAndRenderUserBox === 'function') {
      checkAuthAndRenderUserBox();
    } else {
      console.warn('‚ö†Ô∏è checkAuthAndRenderUserBox function not found');
      // Fallback: render basic user box
      const userInfo = safeGetElement('userInfo');
      if (userInfo) {
        userInfo.innerHTML = `
          <div class="auth-prompt">
            <p class="auth-text">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</p>
            <button class="login-btn" onclick="safeLoadView('login')">
              <span>üîë</span> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
            </button>
          </div>
        `;
      }
    }
  }, 'Auth check');
  
  // Load default view with safety
  setTimeout(() => {
    safeExecute(() => {
      if (typeof loadView === 'function') {
        loadView('calendar');
      } else {
        console.warn('‚ö†Ô∏è loadView function not found');
        safeLoadView('calendar');
      }
    }, 'Load default view');
  }, 500);
});

// Safe loadView function ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö fallback
function safeLoadView(viewName) {
  console.log('üîÑ Safe loading view:', viewName);
  
  const mainContent = safeGetElement('mainContent');
  if (!mainContent) {
    console.error('‚ùå mainContent element not found');
    return;
  }
  
  // Show loading
  mainContent.innerHTML = `
    <div class="loading-placeholder">
      <div class="loading-content">
        <div class="loading-spinner"></div>
        <h3>üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</h3>
        <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</p>
      </div>
    </div>
  `;
  
  // Basic fallback content
  const fallbackContent = {
    calendar: `
      <div class="calendar-container">
        <div class="calendar-header">
          <h4>üìÖ ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</h4>
          <div class="calendar-actions">
            <button class="btn" onclick="location.reload()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
          </div>
        </div>
        <div id="calendar">
          <div style="text-align: center; padding: 40px; color: #666;">
            <h3>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô...</h3>
            <p>‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤</p>
          </div>
        </div>
      </div>
    `,
    login: `
      <div class="auth-container">
        <div class="auth-card">
          <div class="auth-header">
            <h3>üîë ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h3>
          </div>
          <div style="padding: 20px; text-align: center;">
            <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</p>
            <button onclick="location.reload()" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px;">
              üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤
            </button>
          </div>
        </div>
      </div>
    `,
    register: `
      <div class="auth-container">
        <div class="auth-card">
          <div class="auth-header">
            <h3>üìù ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h3>
          </div>
          <div style="padding: 20px; text-align: center;">
            <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</p>
            <button onclick="location.reload()" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px;">
              üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤
            </button>
          </div>
        </div>
      </div>
    `
  };
  
  setTimeout(() => {
    mainContent.innerHTML = fallbackContent[viewName] || fallbackContent.calendar;
    console.log('‚úÖ Fallback content loaded for:', viewName);
  }, 1000);
}

// Export safe functions
window.safeLoadView = safeLoadView;
window.safeGetElement = safeGetElement;
window.safeExecute = safeExecute;

console.log('‚úÖ Emergency error handling loaded');
</script>

<!-- ‡πÄ‡∏û‡∏¥‡πà‡∏° CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö loading ‡πÅ‡∏•‡∏∞ error states -->
<style>
  .loading-placeholder {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 400px;
    background: var(--bg-secondary, #f8f9fa);
  }

  .loading-content {
    text-align: center;
    padding: 40px;
  }

  .loading-spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #1a73e8;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px;
  }

  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }

    100% {
      transform: rotate(360deg);
    }
  }

  .auth-container {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 400px;
    padding: 20px;
  }

  .auth-card {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    padding: 0;
    width: 100%;
    max-width: 400px;
    overflow: hidden;
  }

  .auth-header {
    padding: 20px;
    border-bottom: 1px solid #eee;
    text-align: center;
  }

  .calendar-container {
    padding: 20px;
  }

  .calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 10px;
  }

  .btn {
    padding: 8px 16px;
    background: #1a73e8;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
  }

  .btn:hover {
    background: #1557b0;
  }
</style>

<script>
  /* ========================================
   MEETING ROOM BOOKING SYSTEM - JavaScript
   ======================================== */

// Global variables
let calendar = null;
let currentView = 'calendar';
let isLoading = false;
let userSessionData = null;
let isAuthChecked = false;
let currentUser = null;

/* ========== AUTHENTICATION MANAGEMENT ========== */

function submitLoginForm(event) {
  event.preventDefault();

  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value;
  const sessionToken = localStorage.getItem('booking_session_token');

  google.script.run
    .withSuccessHandler(function(result) {
      console.log('‚úÖ Login successful:', result);
      
      // ‚úÖ ‡πÄ‡∏Å‡πá‡∏ö session token
      if (result.sessionToken) {
        localStorage.setItem('booking_session_token', result.sessionToken);
      }
      
      currentUser = result;
      isAuthChecked = true;
      renderUserBox(result);
      loadView('calendar');
    })
    .withFailureHandler(function(error) {
      console.error('‚ùå Login error:', error.message);
      Swal.fire('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', error.message, 'error');
    })
    .loginUser({ email, pwd: password });

}


function checkAuthAndRenderUserBox() {
  console.log('üîç Checking authentication...');
  
  const sessionToken = localStorage.getItem('booking_session_token');

  if (typeof google !== 'undefined' && google.script && google.script.run) {
    google.script.run
      .withSuccessHandler(function(user) {
        console.log('‚úÖ Auth check result:', user);
        
        // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï global variables
        window.currentUser = user;
        window.isAuthChecked = true;
        window.authChecked = true;
        
        // Update legacy variables
        if (typeof currentUser !== 'undefined') currentUser = user;
        if (typeof isAuthChecked !== 'undefined') isAuthChecked = true;
        if (typeof authChecked !== 'undefined') authChecked = true;
        
        renderUserBox(user);
        console.log('üë§ User status:', user ? `Logged in as ${user.name}` : 'Not logged in');
        
        // Trigger any pending auth checks
        if (window.pendingNavigation) {
          console.log('üîÑ Processing pending navigation:', window.pendingNavigation);
          checkAuthAndNavigate(window.pendingNavigation);
          window.pendingNavigation = null;
        }
      })
      .withFailureHandler(function(error) {
        console.error('‚ùå Auth check failed:', error);
        
        // Set as checked but no user
        window.currentUser = null;
        window.isAuthChecked = true;
        window.authChecked = true;
        
        if (typeof currentUser !== 'undefined') currentUser = null;
        if (typeof isAuthChecked !== 'undefined') isAuthChecked = true;
        if (typeof authChecked !== 'undefined') authChecked = true;
        
        renderUserBox(null);
      })
      .getSessionUser(sessionToken);
  } else {
    // Fallback for testing
    console.log('‚ö†Ô∏è Google Apps Script not available');
    window.currentUser = null;
    window.isAuthChecked = true;
    window.authChecked = true;
    
    if (typeof currentUser !== 'undefined') currentUser = null;
    if (typeof isAuthChecked !== 'undefined') isAuthChecked = true;
    if (typeof authChecked !== 'undefined') authChecked = true;
    
    renderUserBox(null);
  }
}

function renderUserBox(user) {
  const userInfoEl = document.getElementById("userInfo");
  if (!userInfoEl) return;

  if (user) {
    userInfoEl.innerHTML = `
      <div class="user-profile">
        <div class="user-avatar">
          <span class="avatar-icon">üë§</span>
        </div>
        <div class="user-details">
          <p class="user-name">${user.name}</p>
          <p class="user-email">${user.email}</p>
        </div>
      </div>
      <button class="logout-btn" onclick="logout()">
        <span>üö™</span> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
      </button>
    `;
  } else {
    userInfoEl.innerHTML = `
      <div class="auth-prompt">
        <p class="auth-text">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</p>
        <button class="login-btn" onclick="loadView('login')">
          <span>üîë</span> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
        </button>
      </div>
    `;
  }
}

function logout() {
  const clearClientSession = () => {
    // ‚úÖ ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ó‡∏∏‡∏Å‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ authentication ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á
    currentUser = null;
    window.currentUser = null;
    currUser = null;
    isAuthChecked = false;
    window.isAuthChecked = false;
    authChecked = false;
    window.authChecked = false;

    // ‚úÖ ‡∏•‡∏ö session ‡∏à‡∏≤‡∏Å client storage
    localStorage.removeItem('booking_session_token');

    // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI
    if (typeof renderUserBox === 'function') {
      renderUserBox(null);
    }
  };
  const sessionToken = localStorage.getItem('booking_session_token');
  if (typeof google !== 'undefined' && google.script && google.script.run) {
    google.script.run
      .withSuccessHandler(function () {
        clearClientSession();

        if (typeof Swal !== 'undefined') {
          Swal.fire({
            icon: 'success',
            title: '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß',
            text: '‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£',
            timer: 1500,
            showConfirmButton: false
          });
        }

        // ‚úÖ Redirect ‡∏´‡∏•‡∏±‡∏á logout
        setTimeout(() => {
          if (typeof loadView === 'function') {
            loadView('calendar');
          } else {
            location.reload();
          }
        }, 1000);
      })
      .withFailureHandler(function (error) {
        console.error('Logout failed:', error);
        if (typeof Swal !== 'undefined') {
          Swal.fire({
            icon: 'error',
            title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
            text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ'
          });
        }
      })
      .logoutUser(sessionToken);
  } else {
    // ‚úÖ fallback (local mode / dev mode)
    clearClientSession();
    if (typeof loadView === 'function') {
      loadView('calendar');
    } else {
      location.reload();
    }
  }
}

/* ========== CALENDAR MANAGEMENT ========== */

function renderCalendar(events = []) {
  const calendarEl = document.getElementById('calendar');
  if (!calendarEl) {
    console.warn('Calendar element not found');
    return;
  }

  // Destroy existing calendar if it exists
  if (calendar) {
    calendar.destroy();
    calendar = null;
  }

  // Create new calendar instance
  calendar = new FullCalendar.Calendar(calendarEl, {
    // Basic configuration
    initialView: 'dayGridMonth',
    height: '100%',
    locale: 'th',
    firstDay: 0, // Sunday
    
    // Time format
    eventTimeFormat: {
      hour: '2-digit',
      minute: '2-digit',
      hour12: false
    },
    
    // Header toolbar configuration
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
    },
    
    // Button text localization
    buttonText: {
      today: '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ',
      month: '‡πÄ‡∏î‡∏∑‡∏≠‡∏ô',
      week: '‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå',
      day: '‡∏ß‡∏±‡∏ô',
      list: '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'
    },
    
    // Events configuration
    events: events || [],
    eventDisplay: 'block',
    dayMaxEvents: 3,
    moreLinkClick: 'popover',
    
    // Event interactions
    eventClick: function(info) {
      showEventDetails(info.event);
    },
    
    dateClick: function(info) {
      // Quick booking: check auth first
      if (!isAuthChecked) {
        setTimeout(() => calendar.getApi().trigger('dateClick', info), 200);
        return;
      }
      
      if (currentUser) {
        // Pre-fill form with selected date
        const selectedDate = info.dateStr;
        localStorage.setItem('selectedDate', selectedDate);
        loadView('form');
      } else {
        checkAuthAndNavigate('form');
      }
    },

    // Event styling
    eventDidMount: function(info) {
      info.el.setAttribute('title', `${info.event.title}\n‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î`);
      
      // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° class ‡∏ï‡∏≤‡∏°‡∏´‡πâ‡∏≠‡∏á
      const room = info.event.extendedProps?.room;
      if (room) {
        info.el.classList.add(`room-${room}`);
      }
      
      // ‚úÖ ‡πÅ‡∏¢‡∏Å logic ‡∏ï‡∏≤‡∏° view type
      const viewType = info.view.type;
      
      if (viewType === 'listWeek' || viewType === 'listMonth') {
        // List View: ‡πÅ‡∏™‡∏î‡∏á status indicator (‡∏à‡∏∏‡∏î‡∏™‡∏µ)
        addStatusIndicator(info);
      } else {
        // Calendar View: ‡∏ã‡πà‡∏≠‡∏ô‡∏à‡∏∏‡∏î‡∏™‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        removeEventDots(info.el);
      }
    },
    // Loading states
    loading: function(isLoading) {
      toggleLoadingState(isLoading);
    },
    
    // View change handling
    datesSet: function(info) {
      currentView = info.view.type;
    }
  });

  // Render the calendar
  calendar.render();
  
  // ‚úÖ ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å! ‡πÄ‡∏Å‡πá‡∏ö reference ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô window
  window.calendar = calendar;
  
  console.log(`üìÖ Calendar rendered with ${events.length} events`);
}

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏° status indicator (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á)
function addStatusIndicator(info) {
  // ‡∏ã‡πà‡∏≠‡∏ô default dot ‡∏Ç‡∏≠‡∏á FullCalendar ‡∏Å‡πà‡∏≠‡∏ô
  removeEventDots(info.el);
  
  const event = info.event;
  const now = new Date(); // ‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
  
  // ‚úÖ ‡πÅ‡∏õ‡∏•‡∏á start/end ‡πÄ‡∏õ‡πá‡∏ô Date object ‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à
  const startTime = new Date(event.start);
  const endTime = new Date(event.end);
  
  // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î status
  let status = 'upcoming'; // default
  let statusColor = '#FF9800'; // ‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πâ‡∏°‡∏™‡∏î‡πÉ‡∏™ (‡πÅ‡∏ó‡∏ô‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏à‡∏≤‡∏á)
  let statusText = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°';
  
  if (now >= startTime && now < endTime) {
    status = 'ongoing';
    statusColor = '#4CAF50'; // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
    statusText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£';
  } else if (now >= endTime) {
    status = 'completed';
    statusColor = '#9E9E9E'; // ‡πÄ‡∏ó‡∏≤
    statusText = '‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß';
  }
  
  // üêõ Debug log
  console.log('‚úÖ Final status:', status, statusText);
  
  // ‡∏™‡∏£‡πâ‡∏≤‡∏á indicator dot
  const dot = document.createElement('span');
  dot.className = `status-indicator status-${status}`;
  dot.style.cssText = `
    display: inline-block !important;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background-color: ${statusColor} !important;
    margin-right: 8px;
    vertical-align: middle;
    flex-shrink: 0;
    border: 2px solid white;
    box-shadow: 0 0 8px ${statusColor}80, 0 0 0 1px rgba(0,0,0,0.2);
  `;
  dot.setAttribute('title', statusText);
  
  // ‡πÅ‡∏ó‡∏£‡∏Å dot ‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤ title
  const titleEl = info.el.querySelector('.fc-list-event-title, .fc-event-title');
  if (titleEl) {
    // ‡∏•‡∏ö dot ‡πÄ‡∏Å‡πà‡∏≤‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
    const oldDot = titleEl.querySelector('.status-indicator');
    if (oldDot) oldDot.remove();
    
    // ‡πÄ‡∏û‡∏¥‡πà‡∏° dot ‡πÉ‡∏´‡∏°‡πà
    titleEl.insertBefore(dot, titleEl.firstChild);
  }
  
  // ‡πÄ‡∏û‡∏¥‡πà‡∏° class ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö styling ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
  // info.el.classList.add(`event-status-${status}`);
}

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ã‡πà‡∏≠‡∏ô‡∏à‡∏∏‡∏î‡∏™‡∏µ‡πÉ‡∏ô Calendar View
function removeEventDots(element) {
  if (!element) return;
  
  // ‡∏•‡∏ö dot elements ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
  const dots = element.querySelectorAll('.fc-daygrid-event-dot, .fc-list-event-dot, .fc-event-dot');
  dots.forEach(dot => {
    dot.style.display = 'none';
    dot.remove();
  });
  
  // ‡πÄ‡∏û‡∏¥‡πà‡∏° class ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á dot
  element.classList.add('no-event-dot');
}

function showEventDetails(event) {
  const props = event.extendedProps || {};
  const startTime = event.start ? event.start.toLocaleTimeString('th-TH', {
    hour: '2-digit', 
    minute: '2-digit'
  }) : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
  const endTime = event.end ? event.end.toLocaleTimeString('th-TH', {
    hour: '2-digit', 
    minute: '2-digit'
  }) : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';

  const eventDate = event.start ? event.start.toLocaleDateString('th-TH', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  }) : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';

  // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á
  const roomName = getRoomDisplayName(props.room);

  if (typeof Swal !== 'undefined') {
    Swal.fire({
      title: 'üìã ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á',
      html: `
        <div style="text-align: left; margin: 16px 0; line-height: 1.6;">
          <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; margin-bottom: 16px;">   
            <p style="margin: 4px 0; color: var(--text-secondary);"><strong>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ${eventDate}</p>
            <p style="margin: 4px 0; color: var(--text-secondary);"><strong>‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤:</strong> ${startTime} - ${endTime}</p>
            <p style="margin: 4px 0; color: var(--text-secondary);"><strong>üö™ ‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°:</strong> ${roomName}</p>
          </div>
          <p style="margin: 8px 0;"><strong>üë§ ‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á:</strong> ${props.booker || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</p>
          <p style="margin: 8px 0;"><strong>üè¢ ‡∏ù‡πà‡∏≤‡∏¢:</strong> ${props.department || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</p>
          <p style="margin: 8px 0;"><strong>üèõÔ∏è ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó:</strong> ${props.company || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</p>
          <p style="margin: 8px 0;"><strong>üéØ ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå:</strong> ${props.purpose || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</p>
          <p style="margin: 8px 0;"><strong>üìß ‡∏≠‡∏µ‡πÄ‡∏°‡∏•:</strong> ${props.email || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</p>
          <p style="margin: 8px 0;"><strong>üìä ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> ${props.status || '‡∏õ‡∏Å‡∏ï‡∏¥'}</p>
        </div>
      `,
      showCancelButton: true,
      confirmButtonText: '‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç',
      cancelButtonText: '‚ùå ‡∏õ‡∏¥‡∏î',
      confirmButtonColor: '#1a73e8',
      cancelButtonColor: '#6c757d',
      width: '500px'
    }).then((result) => {
      if (result.isConfirmed) {
        // TODO: Implement edit functionality
        editBooking(event.id, props);
      }
    });
  }
}

// ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á
function getRoomDisplayName(roomCode) {
  const roomNames = {
    'MR1': '‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° 1',
    'MR2': '‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° 2',
    'MR3': '‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° 3',
    'MR4': '‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° 4'
  };
  return roomNames[roomCode] || roomCode || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
}

// ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏µ
function getRoomInfo(roomCode) {
  const rooms = {
    'MR1': { name: '‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° 1', color: '#1E88E5' },
    'MR2': { name: '‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° 2', color: '#43A047' },
    'MR3': { name: '‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° 3', color: '#FB8C00' },
    'MR4': { name: '‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° 4', color: '#8E24AA' }
  };
  return rooms[roomCode] || { name: roomCode || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏', color: '#90a4ae' };
}

function refreshCalendarData() {
  if (typeof google !== 'undefined' && google.script && google.script.run) {
    toggleLoadingState(true);
    
    google.script.run
      .withSuccessHandler(function(events) {
        renderCalendar(events);
        toggleLoadingState(false);
        
        if (typeof Swal !== 'undefined') {
          Swal.fire({
            icon: 'success',
            title: '‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
            text: `‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß ${events.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`,
            timer: 1500,
            showConfirmButton: false
          });
        }
      })
      .withFailureHandler(function(error) {
        console.error('Calendar refresh failed:', error);
        toggleLoadingState(false);
        
        if (typeof Swal !== 'undefined') {
          Swal.fire({
            icon: 'error',
            title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
            text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ'
          });
        }
      })
      .listEvents();
  }
}

/* ========== FORM MANAGEMENT ========== */

function handleSubmit(event) {
  event.preventDefault();
  
  const form = event.target;
  const submitBtn = form.querySelector('button[type="submit"]');
  const originalText = submitBtn.innerHTML;
  
  // Disable submit button and show loading
  submitBtn.disabled = true;
  submitBtn.innerHTML = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

  // Collect form data
  const formData = new FormData(form);
  const bookingData = {
    room: formData.get('roomId'),
    date: formData.get('date'),
    start: formData.get('start'),
    end: formData.get('end'),
    name: formData.get('name'),
    department: formData.get('department'),
    company: formData.get('company'),
    purpose: formData.get('purpose'),
    email: formData.get('email')
  };

  // Client-side validation
  if (!validateBookingData(bookingData)) {
    submitBtn.disabled = false;
    submitBtn.innerHTML = originalText;
    return;
  }

  // Submit to server
  if (typeof google !== 'undefined' && google.script && google.script.run) {
    google.script.run
      .withSuccessHandler(function(result) {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
        
        if (result.status === 'ok') {
          if (typeof Swal !== 'undefined') {
            Swal.fire({
              icon: 'success',
              title: '‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üéâ',
              text: '‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
              timer: 2000,
              showConfirmButton: false
            }).then(() => {
              form.reset();
              loadView('calendar', true);
            });
          } else {
            alert('‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
            form.reset();
            loadView('calendar', true);
          }
        }
      })
      .withFailureHandler(function(error) {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
        
        if (typeof Swal !== 'undefined') {
          Swal.fire({
            icon: 'error',
            title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
            text: error.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ'
          });
        } else {
          alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + (error.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ'));
        }
      })
      .submitBooking(bookingData);
  } else {
    // Fallback for testing
    setTimeout(() => {
      submitBtn.disabled = false;
      submitBtn.innerHTML = originalText;
      
      if (typeof Swal !== 'undefined') {
        Swal.fire({
          icon: 'info',
          title: '‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö',
          text: '‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google Apps Script'
        });
      } else {
        alert('‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö: ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google Apps Script');
      }
    }, 1000);
  }
}

function validateBookingData(data) {
  // Check required fields
  if (!data.date || !data.start || !data.end || !data.name) {
    if (typeof Swal !== 'undefined') {
      Swal.fire({
        icon: 'warning',
        title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô',
        text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô'
      });
    } else {
      alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
    }
    return false;
  }

  // Validate time range
  if (data.start >= data.end) {
    if (typeof Swal !== 'undefined') {
      Swal.fire({
        icon: 'warning',
        title: '‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
        text: '‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î'
      });
    } else {
      alert('‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î');
    }
    return false;
  }

  // Check if booking date is in the past
  const bookingDate = new Date(data.date);
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  if (bookingDate < today) {
    if (typeof Swal !== 'undefined') {
      Swal.fire({
        icon: 'warning',
        title: '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
        text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏î‡πâ'
      });
    } else {
      alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏î‡πâ');
    }
    return false;
  }

  // Validate email format if provided
  if (data.email && !isValidEmail(data.email)) {
    if (typeof Swal !== 'undefined') {
      Swal.fire({
        icon: 'warning',
        title: '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
        text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'
      });
    } else {
      alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
    }
    return false;
  }

  return true;
}

function isValidEmail(email) {
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return emailRegex.test(email);
}

/* ========== VIEW MANAGEMENT ========== */
const viewMap = {
  calendar: 'CalendarView',
  form: 'Form',
  list: 'TodayList',
  login: 'Login',
  register: 'Register',
  forgot: 'ForgotPassword'
};

function loadView(viewName, forceRefresh = false) {
  if (isLoading && !forceRefresh) return;
  
  const mainContent = document.getElementById('mainContent');
  if (!mainContent) return;

  // Update navigation active state
  setActiveNav(viewName);
  
  // Show loading state
  if (!forceRefresh) {
    mainContent.innerHTML = `
      <div class="loading-placeholder">
        <div class="loading-content">
          <div class="loading-spinner"></div>
          <h3>üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</h3>
          <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</p>
        </div>
      </div>
    `;
  }

  const templateName = viewMap[viewName] || 'CalendarView';
  
  if (typeof google !== 'undefined' && google.script && google.script.run) {
    isLoading = true;
    
    google.script.run
      .withSuccessHandler(function(html) {
        console.log("‚úÖ Loaded view HTML:", html);
        mainContent.innerHTML = html;
        isLoading = false;
        
        // Post-load actions based on view
        handleViewLoaded(viewName);
      })
      .withFailureHandler(function(error) {
        console.error('Failed to load view:', error);
        mainContent.innerHTML = `
          <div class="error-container">
            <div class="error-content">
              <h3>‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h3>
              <p>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
              <button onclick="loadView('${viewName}')" class="retry-btn">
                üîÑ ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
              </button>
            </div>
          </div>
        `;
        isLoading = false;
      })
      .include(templateName);
  } else {
    // Fallback content for testing
    mainContent.innerHTML = getFallbackContent(viewName);
    handleViewLoaded(viewName);
  }
}

function handleViewLoaded(viewName) {
  switch (viewName) {
    case 'calendar':
      setTimeout(() => {
        if (typeof google !== 'undefined' && google.script && google.script.run) {
          google.script.run
            .withSuccessHandler(renderCalendar)
            .withFailureHandler(function(error) {
              console.error('Failed to load events:', error);
              renderCalendar([]); // Render empty calendar
            })
            .listEvents();
        } else {
          renderCalendar(getSampleEvents());
        }
      }, 100);
      break;
      
    case 'form':
      setupFormDefaults();
      break;
      
    case 'list':
      loadBookingList();
      break;

    case 'login':
      initLoginForm();
      break;
      
    case 'register':
      initRegisterForm();
      break;

    case 'forgot':
      initForgotPassword();  // ‚úÖ ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
      break;
  }

  // Sync theme toggle in header if exists
  const headerToggle = document.getElementById('themeToggleHeader');
  if (headerToggle) {
    const savedTheme = localStorage.getItem("booking-theme") || "light";
    headerToggle.checked = savedTheme === "dark";
  }
}

function initLoginForm() {
  // Login form will be handled by emergency fix scripts
  console.log('Login form initialized');
}

function initRegisterForm() {
  // Register form will be handled by emergency fix scripts  
  console.log('Register form initialized');
}

function setupFormDefaults() {
  // Set default date to today or selected date
  const today = new Date().toISOString().split('T')[0];
  const selectedDate = localStorage.getItem('selectedDate') || today;
  
  const dateInput = document.getElementById('date');
  if (dateInput) {
    dateInput.value = selectedDate;
    dateInput.setAttribute('min', today); // Prevent past dates
  }
  
  // Clear selected date from localStorage
  localStorage.removeItem('selectedDate');

  // Set default time range (9:00 AM - 10:00 AM)
  const startInput = document.getElementById('start');
  const endInput = document.getElementById('end');
  if (startInput && !startInput.value) {
    startInput.value = '09:00';
  }
  if (endInput && !endInput.value) {
    endInput.value = '10:00';
  }
}

function loadBookingList() {
  // TODO: Implement booking list functionality
  const listContainer = document.getElementById('booking-list');
  if (listContainer) {
    listContainer.innerHTML = `
      <div class="text-center" style="padding: 40px; color: var(--text-secondary);">
        <h3>üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
        <p>‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤</p>
      </div>
    `;
  }
}

function setActiveNav(viewName) {
  // Remove active class from all nav items
  document.querySelectorAll('.nav-menu a').forEach(link => {
    link.classList.remove('active');
  });
  
  // Add active class to current nav item
  const activeNav = document.getElementById(`nav-${viewName}`);
  if (activeNav) {
    activeNav.classList.add('active');
  }
  
  console.log('üìç Navigation set to:', viewName);
}

/* ========== UTILITY FUNCTIONS ========== */

function toggleLoadingState(loading) {
  const calendarEl = document.getElementById('calendar');
  if (!calendarEl) return;
  
  if (loading) {
    calendarEl.style.opacity = '0.6';
    calendarEl.style.pointerEvents = 'none';
  } else {
    calendarEl.style.opacity = '1';
    calendarEl.style.pointerEvents = 'auto';
  }
}

function editBooking(eventId, eventData) {
  // TODO: Implement edit booking functionality
  if (typeof Swal !== 'undefined') {
    Swal.fire({
      icon: 'info',
      title: '‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç',
      text: '‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤'
    });
  } else {
    alert('‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤');
  }
}

function getFallbackContent(viewName) {
  const fallbackContents = {
    calendar: `
      <div class="calendar-container">
        <div class="calendar-header">
          <h4>üìÖ ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</h4>
          <div class="calendar-actions">
            <button class="refresh-btn" onclick="refreshCalendarData()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
            <button class="add-btn" onclick="checkAuthAndNavigate('form')">‚ûï ‡∏à‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</button>
          </div>
        </div>
        <div id="calendar"></div>
      </div>
    `,
    form: `
      <div class="form-container">
        <div class="form-header">
          <h3>üìù ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</h3>
          <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google Apps Script ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°</p>
        </div>
      </div>
    `,
    list: `
      <div class="text-center" style="padding: 40px; color: var(--text-secondary);">
        <h3>üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
        <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google Apps Script ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</p>
      </div>
    `,
    login: `
      <div class="text-center" style="padding: 40px; color: var(--text-secondary);">
        <h3>üîë ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h3>
        <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google Apps Script ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
      </div>
    `,
    register: `
      <div class="text-center" style="padding: 40px; color: var(--text-secondary);">
        <h3>üìù ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h3>
        <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google Apps Script ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
      </div>
    `
  };
  
  return fallbackContents[viewName] || fallbackContents.calendar;
}

function getSampleEvents() {
  const today = new Date();
  return [
    {
      id: 'sample-1',
      title: '‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏ó‡∏µ‡∏° IT',
      start: new Date(today.getFullYear(), today.getMonth(), today.getDate() + 1, 9, 0),
      end: new Date(today.getFullYear(), today.getMonth(), today.getDate() + 1, 11, 0),
      backgroundColor: '#1a73e8',
      extendedProps: {
        booker: '‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ',
        department: '‡∏ù‡πà‡∏≤‡∏¢‡πÑ‡∏≠‡∏ó‡∏µ',
        company: '‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ABC',
        purpose: '‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå',
        email: 'somchai@abc.com'
      }
    },
    {
      id: 'sample-2',
      title: '‡∏≠‡∏ö‡∏£‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà',
      start: new Date(today.getFullYear(), today.getMonth(), today.getDate() + 2, 13, 0),
      end: new Date(today.getFullYear(), today.getMonth(), today.getDate() + 2, 16, 0),
      backgroundColor: '#34a853',
      extendedProps: {
        booker: '‡∏™‡∏∏‡∏î‡∏≤ ‡∏ô‡∏±‡∏Å‡∏≠‡∏ö‡∏£‡∏°',
        department: '‡∏ù‡πà‡∏≤‡∏¢ HR',
        company: '‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ABC',
        purpose: '‡∏≠‡∏ö‡∏£‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà',
        email: 'suda@abc.com'
      }
    }
  ];
}

/* ========== ROOM FILTER FUNCTION ========== */
function toggleRoomFilter(room, isChecked) {
  console.log(`üé® Toggle room filter: ${room} = ${isChecked}`);
  
  if (!window.calendar) {
    console.warn('‚ö†Ô∏è Calendar object not found');
    return;
  }
  
  try {
    const allEvents = window.calendar.getEvents();
    
    if (!allEvents || allEvents.length === 0) {
      console.warn('‚ö†Ô∏è No events found');
      return;
    }
    
    let affectedCount = 0;
    
    allEvents.forEach(event => {
      const eventRoom = event.extendedProps?.room;
      
      if (eventRoom === room) {
        // ‚úÖ ‡πÉ‡∏ä‡πâ CSS class ‡πÅ‡∏ó‡∏ô setProp ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ re-render
        const el = event._def?.ui?.classNames || [];
        
        if (isChecked) {
          // ‡πÅ‡∏™‡∏î‡∏á event
          event.setProp('display', 'block');
          event.setProp('classNames', el.filter(c => c !== 'hidden-event'));
        } else {
          // ‡∏ã‡πà‡∏≠‡∏ô event ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà re-render
          event.setProp('display', 'none');
          event.setProp('classNames', [...el, 'hidden-event']);
        }
        
        affectedCount++;
      }
    });
    
    console.log(`‚úÖ ${isChecked ? '‡πÅ‡∏™‡∏î‡∏á' : '‡∏ã‡πà‡∏≠‡∏ô'} ${affectedCount} events ‡∏Ç‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á ${room}`);
    
  } catch (error) {
    console.error('‚ùå Error in toggleRoomFilter:', error);
  }
}

// Helper function ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ä‡πâ getApi()
// function toggleRoomFilterWithApi(calendarApi, room, isChecked) {
//   try {
//     const allEvents = calendarApi.getEvents();
//     let affectedCount = 0;
    
//     allEvents.forEach(event => {
//       const eventRoom = event.extendedProps?.room;
//       if (eventRoom === room) {
//         event.setProp('display', isChecked ? 'auto' : 'none');
//         affectedCount++;
//       }
//     });
    
//     console.log(`‚úÖ ${isChecked ? '‡πÅ‡∏™‡∏î‡∏á' : '‡∏ã‡πà‡∏≠‡∏ô'} ${affectedCount} events ‡∏Ç‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á ${room}`);
//   } catch (error) {
//     console.error('‚ùå Error in toggleRoomFilterWithApi:', error);
//   }
// }

// Export to window
window.toggleRoomFilter = toggleRoomFilter;

// Export to window for global access
window.toggleRoomFilter = toggleRoomFilter;

/* ========== REFRESH CALENDAR ========== */

function refreshCalendar() {
  console.log('üîÑ Refreshing calendar from server...');
  
  if (typeof google !== 'undefined' && google.script && google.script.run) {
    const refreshBtn = document.querySelector('.refresh-btn');
    if (refreshBtn) {
      const originalText = refreshBtn.innerHTML;
      refreshBtn.innerHTML = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';
      refreshBtn.disabled = true;
      
      google.script.run
        .withSuccessHandler(function(events) {
          if (typeof renderCalendar === 'function') {
            renderCalendar(events);
          }
          
          // Reset button
          refreshBtn.innerHTML = originalText;
          refreshBtn.disabled = false;
          
          if (typeof Swal !== 'undefined') {
            Swal.fire({
              icon: 'success',
              title: '‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
              text: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß',
              timer: 1500,
              showConfirmButton: false
            });
          }
          
          console.log('‚úÖ Calendar refreshed successfully');
        })
        .withFailureHandler(function(error) {
          console.error('‚ùå Failed to refresh calendar:', error);
          
          // Reset button
          refreshBtn.innerHTML = originalText;
          refreshBtn.disabled = false;
          
          if (typeof Swal !== 'undefined') {
            Swal.fire({
              icon: 'error',
              title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
              text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á'
            });
          }
        })
        .listEvents();
    }
  } else {
    console.error('‚ùå Google Apps Script not available');
  }
}

/* ========== INITIALIZATION ========== */

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
  console.log('üöÄ Meeting Room Booking System - JavaScript loaded');
  
  // Set up global error handling
  window.addEventListener('error', function(e) {
    console.error('üí• Global error:', e.error);
  });
  
  // Initialize theme
  const savedTheme = localStorage.getItem("booking-theme") || "light";
  document.documentElement.setAttribute("data-theme", savedTheme);
  
  // Check authentication
  checkAuthAndRenderUserBox();
});

// Export functions for global access
window.renderCalendar = renderCalendar;
window.handleSubmit = handleSubmit;
window.loadView = loadView;
window.refreshCalendarData = refreshCalendarData;
window.refreshCalendar = refreshCalendar;
window.checkAuthAndNavigate = checkAuthAndNavigate;
window.renderUserBox = renderUserBox;
window.logout = logout;
window.currentUser = currentUser;
window.isAuthChecked = isAuthChecked;

// Save Login
function handleLogin(event) {
  event.preventDefault();

  const email = document.getElementById('login-email').value.trim();
  const password = document.getElementById('login-password').value.trim();

  if (!email || !password) {
    Swal.fire('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
    return;
  }

  google.script.run
    .withSuccessHandler(function(user) {
      if (user) {
        // ‚úÖ ‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
        currentUser = {
          email: user.email,
          name: user.name,
          role: user.role
        };
        isAuthChecked = true;
        renderUserBox(currentUser);
        loadView('calendar');

        Swal.fire({
          icon: 'success',
          title: '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
          timer: 1500,
          showConfirmButton: false
        });
      } else {
        Swal.fire('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
      }
    })
    .withFailureHandler(function(error) {
      console.error('Login error:', error);
      Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ', 'error');
    })
    .loginWithEmailPassword(email, password); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Apps Script backend
}

document.getElementById("registerForm").addEventListener("submit", function (e) {
  e.preventDefault();

  const btn = document.getElementById("registerBtn");
  btn.disabled = true;
  btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏°‡∏±‡∏Ñ‡∏£...";

  const name = e.target.name.value.trim();
  const email = e.target.email.value.trim();
  const pwd = e.target.pwd.value.trim();
  const repwd = e.target.repwd.value.trim();

  if (!name || !email || !pwd || !repwd) {
    Swal.fire("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô", "", "warning");
    btn.disabled = false;
    btn.innerText = "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ";
    return;
  }

  if (pwd !== repwd) {
    Swal.fire("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô", "", "error");
    btn.disabled = false;
    btn.innerText = "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ";
    return;
  }

  const user = { name, email, pwd };

  google.script.run
    .withSuccessHandler(function (res) {
      Swal.fire({
        icon: "success",
        title: "‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à",
        text: "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß",
        timer: 1500,
        showConfirmButton: false
      });
      setTimeout(() => loadView("login"), 1500);
    })
    .withFailureHandler(function (err) {
      Swal.fire({
        icon: "error",
        title: "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î",
        text: err.message || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏î‡πâ"
      });
      btn.disabled = false;
      btn.innerText = "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ";
    })
    .registerUser(user);
});

// 1. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç checkAuthAndNavigate function ‡πÉ‡∏ô JavaScript.html
function checkAuthAndNavigate(viewName) {
  console.log('üîç checkAuthAndNavigate called for:', viewName);
  console.log('üîç Current auth state:', {
    currentUser: window.currentUser,
    isAuthChecked: window.isAuthChecked || isAuthChecked,
    authChecked: window.authChecked
  });

  // ‡πÉ‡∏ä‡πâ global variable ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
  const user = window.currentUser || currentUser;
  const checked = window.isAuthChecked || isAuthChecked || window.authChecked || authChecked;

  if (!checked) {
    console.log('‚è≥ Auth not checked yet, waiting...');
    // ‡∏£‡∏≠‡πÉ‡∏´‡πâ auth check ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô
    setTimeout(() => checkAuthAndNavigate(viewName), 300);
    return;
  }

  if (user && user.email) {
    console.log('‚úÖ User authenticated, proceeding to:', viewName);
    // User is logged in, proceed to view
    loadView(viewName);
  } else {
    console.log('‚ùå User not authenticated, showing login prompt');
    // User not logged in, show login prompt
    if (typeof Swal !== 'undefined') {
      Swal.fire({
        icon: 'info',
        title: '‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö',
        text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°',
        showCancelButton: true,
        confirmButtonText: '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö',
        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
        confirmButtonColor: '#1a73e8',
        cancelButtonColor: '#6c757d'
      }).then((result) => {
        if (result.isConfirmed) {
          loadView('login');
        }
      });
    } else {
      // Fallback without SweetAlert
      if (confirm('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°')) {
        loadView('login');
      }
    }
  }
}


</script>

<script>
  function initForgotPassword() {
  const form = document.getElementById('forgotForm');
  if (!form) return;

  form.addEventListener('submit', function (e) {
    e.preventDefault();

    // ‚úÖ ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å id ‡∏ï‡∏£‡∏á ‡πÜ ‡∏à‡∏∞‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏Å‡∏ß‡πà‡∏≤
    const email = document.getElementById("forgotEmail").value.trim();
    const newPassword = document.getElementById("newPassword").value.trim();

    if (!email || !newPassword) {
      Swal.fire("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö", "", "warning");
      return;
    }

    const payload = { email, password: newPassword };

    console.log('üîê Submitting resetPassword:', payload);

    if (typeof google !== 'undefined' && google.script && google.script.run) {
      google.script.run
        .withSuccessHandler(function (res) {
          console.log('‚úÖ resetPassword response:', res);
          Swal.fire("‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "", "success").then(() => {
            loadView('login');
          });
        })
        .withFailureHandler(function (err) {
          console.error('‚ùå resetPassword error:', err);
          Swal.fire("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", err.message || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ", "error");
        })
        .resetPassword(payload);  // ‡∏ä‡∏∑‡πà‡∏≠‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Code.gs ‡πÅ‡∏•‡πâ‡∏ß
    }
  });
}
</script>

<script>
  function handleResetClick() {
  const email = document.getElementById("forgotEmail").value.trim();
  const newPassword = document.getElementById("newPassword").value.trim();

  if (!email || !newPassword) {
    Swal.fire("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö", "", "warning");
    return;
  }

  const payload = { email, password: newPassword };
  console.log('üîê Submitting resetPassword:', payload);

  if (typeof google !== 'undefined' && google.script && google.script.run) {
    google.script.run
      .withSuccessHandler(function (res) {
        console.log('‚úÖ resetPassword response:', res);
        Swal.fire("‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "", "success").then(() => {
          loadView('login');
        });
      })
      .withFailureHandler(function (err) {
        console.error('‚ùå resetPassword error:', err);
        Swal.fire("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", err.message || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ", "error");
      })
      .resetPassword(payload);
  }
}
</script>




<!-- ===== Emergency Frontend Fix - ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô JavaScript.html ===== -->
<script>
  // üö® EMERGENCY FIX - Debug ‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Frontend

// 1. Override handleLoginSubmit function
function handleLoginSubmit(event) {
  event.preventDefault();
  
  console.log('üîë Login form submitted (DEBUG VERSION)');
  
  const form = event.target;
  const formData = new FormData(form);
  
  // Get values multiple ways to debug
  const email1 = document.getElementById('loginEmail')?.value?.trim();
  const password1 = document.getElementById('loginPassword')?.value?.trim();
  const email2 = formData.get('email')?.trim?.();
  const password2 = formData.get('pwd')?.trim?.();
  
  console.log('üìß Email methods:', {
    getElementById: email1,
    formData: email2,
    types: {
      email1: typeof email1,
      email2: typeof email2
    }
  });
  
  console.log('üîë Password methods:', {
    getElementById: password1 ? '***' : 'empty',
    formData: password2 ? '***' : 'empty',
    lengths: {
      password1: password1?.length || 0,
      password2: password2?.length || 0
    }
  });
  
  // Use the most reliable values
  const email = email1 || email2 || '';
  const password = password1 || password2 || '';
  
  console.log('üéØ Final values:', {
    email: email,
    passwordProvided: !!password,
    emailLength: email.length,
    passwordLength: password.length
  });
  
  // Validate
  if (!email) {
    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•');
    console.log('‚ùå Email validation failed');
    return;
  }
  
  if (!password) {
    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô');
    console.log('‚ùå Password validation failed');
    return;
  }
  
  // Email format validation
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(email)) {
    alert('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
    console.log('‚ùå Email format validation failed');
    return;
  }
  
  const btn = document.getElementById('loginBtn');
  if (btn) {
    btn.disabled = true;
    btn.innerHTML = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...';
  }
  
  console.log('üöÄ Calling Google Apps Script...');
  
  // Multiple call methods for debugging
  if (typeof google !== 'undefined' && google.script && google.script.run) {
    
    // Method 1: loginUser with object
    console.log('üìû Trying Method 1: loginUser({email, pwd})');
    google.script.run
      .withSuccessHandler(function(result) {
        console.log('‚úÖ Method 1 SUCCESS:', result);
        handleLoginSuccess(result, btn);
      })
      .withFailureHandler(function(error) {
        console.log('‚ùå Method 1 FAILED, trying Method 2...');
        console.error('Method 1 error:', error);
        
        // Method 2: loginWithEmailPassword
        console.log('üìû Trying Method 2: loginWithEmailPassword(email, password)');
        google.script.run
          .withSuccessHandler(function(result) {
            console.log('‚úÖ Method 2 SUCCESS:', result);
            handleLoginSuccess(result, btn);
          })
          .withFailureHandler(function(error) {
            console.log('‚ùå Method 2 FAILED, trying Method 3...');
            console.error('Method 2 error:', error);
            
            // Method 3: testFrontendInput for debugging
            console.log('üìû Trying Method 3: testFrontendInput for debugging');
            google.script.run
              .withSuccessHandler(function(result) {
                console.log('‚úÖ Method 3 (debug) result:', result);
                if (result.error) {
                  handleLoginError(result.error, btn);
                } else {
                  handleLoginSuccess(result, btn);
                }
              })
              .withFailureHandler(function(error) {
                console.log('‚ùå All methods failed');
                console.error('Method 3 error:', error);
                handleLoginError(error.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö', btn);
              })
              .testFrontendInput(email, password);
          })
          .loginWithEmailPassword(email, password);
      })
      .loginUser({email: email, pwd: password});
      
  } else {
    console.log('‚ö†Ô∏è Google Apps Script not available');
    if (btn) {
      btn.disabled = false;
      btn.innerHTML = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
    }
    alert('‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö: ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google Apps Script ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á');
  }
}

function handleLoginSuccess(result, btn) {
  console.log('üéâ Login successful!', result);
  
  if (btn) {
    btn.disabled = false;
    btn.innerHTML = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
  }
  
  if (result && result.email) {
    // ‚úÖ ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï global variables ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    window.currentUser = result;
    window.isAuthChecked = true;
    window.authChecked = true;
    
    // Update legacy variables too
    if (typeof currentUser !== 'undefined') currentUser = result;
    if (typeof isAuthChecked !== 'undefined') isAuthChecked = true;
    if (typeof authChecked !== 'undefined') authChecked = true;
    
    console.log('‚úÖ Global auth state updated:', {
      windowCurrentUser: window.currentUser,
      windowIsAuthChecked: window.isAuthChecked,
      windowAuthChecked: window.authChecked
    });
    
    // Show success message
    if (typeof Swal !== 'undefined') {
      Swal.fire({
        icon: 'success',
        title: '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üéâ',
        text: `‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ${result.name}`,
        timer: 2000,
        showConfirmButton: false
      });
    } else {
      alert(`‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ${result.name}`);
    }
    
    // Update user box
    if (typeof renderUserBox === 'function') {
      renderUserBox(result);
    }
    
    // Redirect to calendar
    setTimeout(() => {
      if (typeof loadView === 'function') {
        loadView('calendar');
      } else {
        console.log('‚úÖ Login complete - should redirect to calendar');
        location.reload();
      }
    }, 1500);
    
  } else {
    console.error('‚ùå Invalid login response:', result);
    handleLoginError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö', btn);
  }
}

function handleLoginError(errorMessage, btn) {
  console.error('‚ùå Login error:', errorMessage);
  
  if (btn) {
    btn.disabled = false;
    btn.innerHTML = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
  }
  
  if (typeof Swal !== 'undefined') {
    Swal.fire({
      icon: 'error',
      title: '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
      text: errorMessage
    });
  } else {
    alert('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + errorMessage);
  }
}

function loadBookingFormView() {
  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
  const sessionToken = localStorage.getItem('booking_session_token');
  
  google.script.run.withSuccessHandler(function(user) {
    if (!user || !user.email) {
      Swal.fire({
        icon: 'info',
        title: '‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö',
        text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°',
        showCancelButton: true,
        confirmButtonText: '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö',
        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
      }).then((result) => {
        if (result.isConfirmed) {
          loadView('login');
        }
      });
      return;
    }

    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°
    ensureAuth(() => {
      loadView('form');
    });

  }).getSessionUser(sessionToken);
}


// 2. Override handleRegisterSubmit function
function handleRegisterSubmit(event) {
  event.preventDefault();
  
  console.log('üìù Register form submitted (DEBUG VERSION)');
  
  const form = event.target;
  
  // Get form data multiple ways
  const name = document.getElementById('name')?.value?.trim() || document.getElementById('registerName')?.value?.trim();
  const nickname = document.getElementById('nickname')?.value?.trim() || document.getElementById('registerNickname')?.value?.trim();
  const email = document.getElementById('email')?.value?.trim() || document.getElementById('registerEmail')?.value?.trim();
  const password = document.getElementById('password')?.value?.trim() || document.getElementById('registerPassword')?.value?.trim();
  const phone = document.getElementById('phone')?.value?.trim() || document.getElementById('registerPhone')?.value?.trim();
  
  console.log('üìã Register data:', {
    name: name,
    nickname: nickname,
    email: email,
    passwordProvided: !!password,
    phone: phone
  });
  
  // Validate
  if (!name) {
    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•');
    return;
  }
  
  if (!email) {
    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•');
    return;
  }
  
  if (!password) {
    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô');
    return;
  }
  
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(email)) {
    alert('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
    return;
  }
  
  const btn = document.getElementById('submitBtn') || document.getElementById('registerBtn');
  if (btn) {
    btn.disabled = true;
    btn.innerHTML = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏°‡∏±‡∏Ñ‡∏£...';
  }
  
  const userData = {
    name: name,
    nickname: nickname || '',
    email: email,
    password: password,
    phone: phone || ''
  };
  
  console.log('üöÄ Sending register data:', userData);
  
  if (typeof google !== 'undefined' && google.script && google.script.run) {
    google.script.run
      .withSuccessHandler(function(result) {
        console.log('‚úÖ Register successful:', result);
        
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ';
        }
        
        if (typeof Swal !== 'undefined') {
          Swal.fire({
            icon: 'success',
            title: '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üéâ',
            text: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...',
            timer: 2000,
            showConfirmButton: false
          });
        } else {
          alert('‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...');
        }
        
        form.reset();
        
        setTimeout(() => {
          if (typeof loadView === 'function') {
            loadView('login');
          } else {
            location.reload();
          }
        }, 2000);
      })
      .withFailureHandler(function(error) {
        console.error('‚ùå Register failed:', error);
        
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ';
        }
        
        if (typeof Swal !== 'undefined') {
          Swal.fire({
            icon: 'error',
            title: '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
            text: error.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'
          });
        } else {
          alert('‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (error.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'));
        }
      })
      .registerUser(userData);
  } else {
    console.log('‚ö†Ô∏è Google Apps Script not available');
    if (btn) {
      btn.disabled = false;
      btn.innerHTML = '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ';
    }
    alert('‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö: ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google Apps Script ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á');
  }
}

// 3. Global override - attach to window
window.handleLoginSubmit = handleLoginSubmit;
window.handleRegisterSubmit = handleRegisterSubmit;

// 4. Auto-attach event listeners when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
  console.log('üîß Attaching emergency event listeners...');
  
  // Login form
  const loginForm = document.getElementById('loginForm');
  if (loginForm) {
    loginForm.onsubmit = handleLoginSubmit;
    console.log('‚úÖ Login form handler attached');
  }
  
  // Register form
  const registerForm = document.getElementById('registerForm');
  if (registerForm) {
    registerForm.onsubmit = handleRegisterSubmit;
    console.log('‚úÖ Register form handler attached');
  }
});

// 5. Periodic check for forms (in case they're loaded dynamically)
setInterval(function() {
  const loginForm = document.getElementById('loginForm');
  const registerForm = document.getElementById('registerForm');
  
  if (loginForm && !loginForm.onsubmit) {
    loginForm.onsubmit = handleLoginSubmit;
    console.log('üîß Login form handler re-attached');
  }
  
  if (registerForm && !registerForm.onsubmit) {
    registerForm.onsubmit = handleRegisterSubmit;
    console.log('üîß Register form handler re-attached');
  }
}, 2000);

console.log('‚úÖ Emergency frontend fixes loaded');

</script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
  const forgotForm = document.getElementById('forgotForm');
  if (forgotForm) {
    forgotForm.addEventListener('submit', function(e) {
      e.preventDefault();

      const email = document.getElementById('forgotEmail').value.trim();
      const password = document.getElementById('newPassword').value;

      if (!email || !password) {
        Swal.fire('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô');
        return;
      }

      google.script.run
        .withSuccessHandler(() => {
          Swal.fire('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '', 'success').then(() => {
            loadView('login');
          });
        })
        .withFailureHandler(error => {
          Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', error.message || error, 'error');
        })
        .resetPassword({ email, password }); // ‚úÖ ‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö Register
    });
  }
});
</script>

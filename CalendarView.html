<!-- CalendarView.html -->
<div class="calendar-container">
  <div class="calendar-header">
    <h4>üìÖ ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</h4>
    <div class="calendar-actions">
      <button class="fc-button refresh-btn" onclick="refreshCalendar()" title="‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•">
        üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
      </button>
      <button class="fc-button add-btn" onclick="checkAuthAndNavigate('form')" title="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà">
         ‚ûï ‡∏à‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
      </button>

      <!-- Theme Toggle ‡∏¢‡πâ‡∏≤‡∏¢‡∏°‡∏≤‡πÑ‡∏ß‡πâ‡πÉ‡∏ô header -->
      <div class="theme-switch-wrapper-header">
        <label class="theme-switch">
          <input type="checkbox" id="themeToggleHeader" onchange="toggleTheme()" />
          <span class="slider">
            <svg class="icon moon" viewBox="0 0 24 24" fill="currentColor">
              <path d="M21 12.79A9 9 0 0 1 11.21 3c-.16 0-.31.01-.47.02A9 9 0 1 0 21 12.79Z"/>
            </svg>
            <svg class="icon sun" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 18a6 6 0 1 0 0-12 6 6 0 0 0 0 12Zm0 2a8 8 0 1 1 0-16 8 8 0 0 1 0 16Z"/>
            </svg>
          </span>
        </label>
      </div>
    </div>
  </div>

  <!-- Calendar Display Area -->
  <div id="calendar"></div>

  <!-- Calendar Footer : Room Legend -->
  <div class="calendar-legend room-legend">
    <label class="legend-item">
      <input type="checkbox" checked data-room="MR1" onchange="toggleRoomFilter('MR1', this.checked)">
      <span class="legend-color mr1"></span>
      ‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° 1
    </label>

    <label class="legend-item">
      <input type="checkbox" checked data-room="MR2" onchange="toggleRoomFilter('MR2', this.checked)">
      <span class="legend-color mr2"></span>
      ‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° 2
    </label>

    <label class="legend-item">
      <input type="checkbox" checked data-room="MR3" onchange="toggleRoomFilter('MR3', this.checked)">
      <span class="legend-color mr3"></span>
      ‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° 3
    </label>

    <label class="legend-item">
      <input type="checkbox" checked data-room="MR4" onchange="toggleRoomFilter('MR4', this.checked)">
      <span class="legend-color mr4"></span>
      ‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° 4
    </label>
  </div>

<style>

  .legend-color.mr1 { background: #A1CEFF; } /* ‡∏ü‡πâ‡∏≤ */
  .legend-color.mr2 { background: #FFC7A1; } /* ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß */
  .legend-color.mr3 { background: #FFA1AA; } /* ‡∏ä‡∏°‡∏û‡∏π */
  .legend-color.mr4 { background: #D2A1FF; } /* ‡∏°‡πà‡∏ß‡∏á */

  .calendar-actions {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .refresh-btn,
  .add-btn {
    font-size: 14px !important;
    padding: 8px 12px !important;
    border-radius: 6px !important;
    font-weight: 500 !important;
    cursor: pointer !important;
    transition: all 0.2s ease !important;
  }

  .refresh-btn:hover,
  .add-btn:hover {
    transform: translateY(-1px) !important;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
  }

  .add-btn {
    background: var(--google-blue) !important;
    color: white !important;
    border-color: var(--google-blue) !important;
  }

  .add-btn:hover {
    background: var(--google-blue-hover) !important;
  }

  /* Theme toggle in header */
  .theme-switch-wrapper-header {
    margin-left: 8px;
  }

  .theme-switch-wrapper-header .theme-switch {
    position: relative;
    display: inline-block;
    width: 48px;
    height: 28px;
  }

  .theme-switch-wrapper-header .theme-switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  .theme-switch-wrapper-header .slider {
    background-color: var(--google-gray-600);
    border-radius: 28px;
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    transition: var(--transition);
    box-shadow: var(--shadow-1);
  }

  .theme-switch-wrapper-header .slider::before {
    position: absolute;
    content: "";
    height: 20px;
    width: 20px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    border-radius: 50%;
    transition: var(--transition);
    z-index: 2;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
  }

  .theme-switch-wrapper-header input:checked+.slider {
    background-color: var(--google-blue);
  }

  .theme-switch-wrapper-header input:checked+.slider::before {
    transform: translateX(20px);
  }

  .theme-switch-wrapper-header .icon {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 10px;
    height: 10px;
    pointer-events: none;
    transition: var(--transition);
  }

  .theme-switch-wrapper-header .sun {
    left: 6px;
    opacity: 1;
  }

  .theme-switch-wrapper-header .moon {
    right: 6px;
    opacity: 0.3;
  }

  .theme-switch-wrapper-header input:checked+.slider .moon {
    opacity: 1;
  }

  .theme-switch-wrapper-header input:checked+.slider .sun {
    opacity: 0.3;
  }

  [data-theme="dark"] .theme-switch-wrapper-header input:checked+.slider {
    background-color: #8ab4f8;
  }

  .calendar-footer {
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid var(--border-color);
  }

  .calendar-legend {
    display: flex;
    justify-content: center;
    gap: 24px;
    flex-wrap: wrap;
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    color: var(--text-secondary);
  }

  .legend-color {
    width: 12px;
    height: 12px;
    border-radius: 2px;
    display: inline-block;
  }

  @media (max-width: 768px) {
    .calendar-header {
      flex-direction: column;
      gap: 12px;
      text-align: center;
    }

    .calendar-header h4 {
      font-size: 18px;
    }

    .calendar-actions {
      justify-content: center;
      flex-wrap: wrap;
    }

    .theme-switch-wrapper-header {
      margin-left: 0;
      margin-top: 8px;
    }

    .calendar-legend {
      gap: 16px;
      font-size: 12px;
    }

    .legend-item {
      gap: 6px;
    }

    .legend-color {
      width: 10px;
      height: 10px;
    }

    /* ===== Room Legend ===== */
    .room-legend {
      justify-content: center;
    }

    .room-legend .legend-item {
      cursor: pointer;
      user-select: none;
    }

    .room-legend input {
      margin-right: 6px;
      cursor: pointer;
    }
  }
</style>

<script>
  function safeNavigateToForm() {
  console.log('üîÑ Safe navigate to form called from calendar');
  
  // Check if global function exists
  if (typeof window.safeNavigateToForm === 'function' && window.safeNavigateToForm !== safeNavigateToForm) {
    window.safeNavigateToForm();
    return;
  }
  
  // Fallback: use checkAuthAndNavigate directly
  if (typeof checkAuthAndNavigate === 'function') {
    checkAuthAndNavigate('form');
  } else if (typeof window.checkAuthAndNavigate === 'function') {
    window.checkAuthAndNavigate('form');
  } else {
    // Last resort: direct navigation with simple auth check
    const user = window.currentUser || currentUser;
    if (user && user.email) {
      loadView('form');
    } else {
      if (typeof Swal !== 'undefined') {
        Swal.fire({
          icon: 'info',
          title: '‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö',
          text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°',
          confirmButtonText: '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö'
        }).then(() => {
          loadView('login');
        });
      } else {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°');
        loadView('login');
      }
    }
  }
}
  // Refresh calendar data
  function refreshCalendar() {
    if (typeof google !== 'undefined' && google.script && google.script.run) {
      // Show loading state
      const refreshBtn = document.querySelector('.refresh-btn');
      const originalText = refreshBtn.innerHTML;
      refreshBtn.innerHTML = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';
      refreshBtn.disabled = true;

      // Call server function to get updated events
      google.script.run
        .withSuccessHandler(function(events) {
          if (window.calendar && typeof renderCalendar === 'function') {
            renderCalendar(events);
          }
          
          // Reset button
          refreshBtn.innerHTML = originalText;
          refreshBtn.disabled = false;
          
          // Show success message
          if (typeof Swal !== 'undefined') {
            Swal.fire({
              icon: 'success',
              title: '‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
              text: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß',
              timer: 1500,
              showConfirmButton: false
            });
          }
        })
        .withFailureHandler(function(error) {
          console.error('Failed to refresh calendar:', error);
          
          // Reset button
          refreshBtn.innerHTML = originalText;
          refreshBtn.disabled = false;
          
          // Show error message
          if (typeof Swal !== 'undefined') {
            Swal.fire({
              icon: 'error',
              title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
              text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á'
            });
          }
        })
        .listEvents();
    } else {
      // Fallback for testing/development
      console.log('Google Apps Script not available - using fallback refresh');
      if (window.calendar && typeof renderCalendar === 'function') {
        renderCalendar([]);
      }
    }
  }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á event ‡∏ï‡∏≤‡∏°‡∏´‡πâ‡∏≠‡∏á
  function toggleRoomFilter(room, isChecked) {
    if (!window.calendar) {
      console.warn('Calendar not initialized yet');
      return;
    }

    // ‡∏î‡∏∂‡∏á events ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    const allEvents = window.calendar.getEvents();
    
    // ‡∏ß‡∏ô‡∏´‡∏≤‡πÅ‡∏Ñ‡πà event ‡∏Ç‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    allEvents.forEach(event => {
      const eventRoom = event.extendedProps?.room;
      
      if (eventRoom === room) {
        // ‡∏ñ‡πâ‡∏≤ checkbox ‡∏ï‡∏¥‡πä‡∏Å ‚Üí ‡πÅ‡∏™‡∏î‡∏á event
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ï‡∏¥‡πä‡∏Å ‚Üí ‡∏ã‡πà‡∏≠‡∏ô event
        event.setProp('display', isChecked ? 'auto' : 'none');
      }
    });
    
    console.log(`${isChecked ? '‡πÅ‡∏™‡∏î‡∏á' : '‡∏ã‡πà‡∏≠‡∏ô'} ‡∏´‡πâ‡∏≠‡∏á ${room}`);
  }

  // Initialize theme toggle in header when view loads
  document.addEventListener('DOMContentLoaded', function() {
    // Sync header toggle with main toggle
    const headerToggle = document.getElementById('themeToggleHeader');
    if (headerToggle) {
      const savedTheme = localStorage.getItem("booking-theme") || "light";
      headerToggle.checked = savedTheme === "dark";
    }
  });

  // Toggle theme function
  function toggleTheme() {
    const headerToggle = document.getElementById('themeToggleHeader');
    
    let newTheme;
    if (headerToggle && headerToggle.checked !== undefined) {
      newTheme = headerToggle.checked ? "dark" : "light";
    } else {
      // Fallback to current theme
      const currentTheme = document.documentElement.getAttribute("data-theme") || "light";
      newTheme = currentTheme === "dark" ? "light" : "dark";
    }
    
    // Apply theme
    document.documentElement.setAttribute("data-theme", newTheme);
    localStorage.setItem("booking-theme", newTheme);
    
    // Update global toggle function if exists
    if (typeof window.toggleTheme === 'function' && window.toggleTheme !== toggleTheme) {
      window.toggleTheme = toggleTheme;
    }
    
    console.log('üé® Theme changed to:', newTheme);
  }

  // Initialize when this view loads
  setTimeout(initializeThemeToggle, 100);

    // Initialize room filter when calendar view loads
  function initRoomFilters() {
    console.log('üé® Initializing room filters...');
    
    const checkboxes = document.querySelectorAll('.room-legend input[type="checkbox"]');
    
    if (!checkboxes || checkboxes.length === 0) {
      console.warn('‚ö†Ô∏è No filter checkboxes found');
      return;
    }
    
    checkboxes.forEach(checkbox => {
      checkbox.addEventListener('change', function() {
        const room = this.dataset.room;
        const isChecked = this.checked;
        
        console.log(`Checkbox changed: ${room} = ${isChecked}`);
        
        if (typeof window.toggleRoomFilter === 'function') {
          window.toggleRoomFilter(room, isChecked);
        } else {
          console.error('toggleRoomFilter function not found!');
        }
      });
    });
    
    console.log('‚úÖ Room filters initialized');
  }

  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà calendar ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
  setTimeout(initRoomFilters, 500);
</script>

